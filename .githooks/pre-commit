#!/usr/bin/env bash
set -euo pipefail

# Keep existing protection for committing docs/modules.docx unless bypassed
if [ "${SKIP_DOCX_HOOK:-0}" = "1" ]; then
  echo "[pre-commit] SKIP_DOCX_HOOK=1 set; skipping docx check."
else
  if git diff --cached --name-only | grep -E "^docs/modules\.docx$" >/dev/null 2>&1; then
    echo "Detected staged docs/modules.docx. To commit regenerated docs, run tools/regenerate_and_commit.ps1 or set SKIP_DOCX_HOOK=1 to bypass."
    exit 1
  fi
fi

# Ensure we run from repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

PINT="vendor/bin/pint"
PHPSTAN="vendor/bin/phpstan"

echo "[pre-commit] Running Pint (staged files only if possible)..."
if [ -x "$PINT" ]; then
  STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(php|blade\.php)$' || true)
  if [ -n "$STAGED" ]; then
    echo "$STAGED" | xargs -r "$PINT" -v --
  else
    "$PINT" -v
  fi
else
  echo "Pint not found; skipping" >&2
fi

# Lint staged Markdown files with markdownlint (if available)
echo "[pre-commit] Linting Markdown (staged files)..."
STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\\.md$' || true)
if [ -n "$STAGED_MD" ]; then
  MDL_BIN="./node_modules/.bin/markdownlint"
  if [ -x "$MDL_BIN" ]; then
    echo "$STAGED_MD" | xargs -r "$MDL_BIN" -c .markdownlint.jsonc --
  elif command -v npx >/dev/null 2>&1; then
    # Use npx to run markdownlint-cli without a local install
    echo "$STAGED_MD" | xargs -r npx --yes markdownlint-cli -c .markdownlint.jsonc --
  else
    echo "markdownlint not available; skipping Markdown lint" >&2
  fi
else
  echo "[pre-commit] No staged Markdown files."
fi

echo "[pre-commit] Running PHPStan..."
if [ -x "$PHPSTAN" ]; then
  "$PHPSTAN" analyse -c phpstan.neon.dist --no-progress --memory-limit=1G
else
  echo "PHPStan not found; skipping" >&2
fi

echo "[pre-commit] Running tests..."
php artisan test --parallel --recreate-databases

echo "[pre-commit] All checks passed."
