#!/usr/bin/env bash
set -euo pipefail

# Keep existing protection for committing docs/modules.docx unless bypassed
if [ "${SKIP_DOCX_HOOK:-0}" = "1" ]; then
  echo "[pre-commit] SKIP_DOCX_HOOK=1 set; skipping docx check."
else
  if git diff --cached --name-only | grep -E "^docs/modules\.docx$" >/dev/null 2>&1; then
    echo "Detected staged docs/modules.docx. To commit regenerated docs, run tools/regenerate_and_commit.ps1 or set SKIP_DOCX_HOOK=1 to bypass."
    exit 1
  fi
fi

# Ensure we run from repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

PINT="vendor/bin/pint"
PHPSTAN="vendor/bin/phpstan"

echo "[pre-commit] Running Pint..."
if [ -x "$PINT" ]; then
  "$PINT" -v
else
  echo "Pint not found; skipping" >&2
fi

echo "[pre-commit] Running PHPStan..."
if [ -x "$PHPSTAN" ]; then
  "$PHPSTAN" analyse -c phpstan.neon.dist --no-progress --memory-limit=1G
else
  echo "PHPStan not found; skipping" >&2
fi

echo "[pre-commit] Running tests..."
php artisan test --parallel --recreate-databases

echo "[pre-commit] All checks passed."
